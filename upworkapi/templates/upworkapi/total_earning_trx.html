{% extends "base.html" %}

{% load humanize %}

{% block description %}Transactional history view (gross/net switch).{% endblock %}

{% block body %}

<style>
  #earning_graph{
    width: 100%;
    height: 420px;
  }
  #client_pie, #client_pie_yearly{
    width: 100%;
    min-height: 520px;
  }
  .col-date{
    width: 140px;
    white-space: nowrap;
  }
  .col-amount{
    width: 120px;
    white-space: nowrap;
    text-align: right;
  }
  .earning-detail-weekly{
    table-layout: fixed;
    width: 100%;
  }
  .earning-detail-weekly .col-num{
    width: 48px;
  }
  .earning-detail-weekly .col-week{
    width: 60px;
  }
  .earning-detail-weekly .col-date{
    width: 110px;
  }
  .earning-detail-weekly .col-amount{
    width: 110px;
  }
  .earning-detail-weekly .col-client,
  .earning-detail-weekly .col-description{
    white-space: normal;
    overflow-wrap: anywhere;
    word-break: break-word;
  }
  .amount{
    text-align: right;
  }
  @media (max-width: 576px){
    #client_pie, #client_pie_yearly{
      min-height: 420px;
    }
  }
</style>

<div class="row">
  <div class="col-lg-12">

    <div class="row align-items-center mb-3">
      <div class="col-lg-12 d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Total Earning {{ graph.month }} {{ graph.year }}</h3>
        <div>
          {% if net_view %}
            <a class="btn btn-outline-secondary" href="?year={{ graph.year }}">Gross View</a>
          {% else %}
            <a class="btn btn-outline-secondary" href="?year={{ graph.year }}&net=1">Net View</a>
          {% endif %}
        </div>
      </div>
    </div>

    <form class="form-inline mb-3 d-flex align-items-center"
      id="year-form"
      method="post"
      action="{% url 'total_earning_graph' %}">
      {% csrf_token %}

      <div class="input-group mr-2" id="year-picker" data-target-input="nearest" style="max-width:240px;">
        <input type="text"
              class="form-control datetimepicker-input"
              data-target="#year-picker"
              readonly
              name="year"
              value="{{ graph.year }}" />
        <div class="input-group-append" data-target="#year-picker" data-toggle="datetimepicker">
          <div class="input-group-text"><i class="fa fa-calendar"></i></div>
        </div>
      </div>

      {% if graph.month %}
      <div class="ml-auto">
        <a href="{% url 'total_earning_graph' %}?year={{ graph.year }}{% if net_view %}&net=1{% endif %}" class="btn btn-primary">
          ‚Üê Back
        </a>
      </div>
      {% endif %}

      <input type="hidden" name="month" value="">
    </form>

    <div class="row">
      <div class="col-lg-6">
        <p class="lead mb-3">
          <table>
            <tr>
              <td class="w-50">Total Earning</td>
              <td>: <span class="text-success">$ {{ graph.total_earning|floatformat:2|intcomma }}</span></td>
            </tr>
            <tr>
              <td class="w-50">Service Fee</td>
              <td>: <span class="text-danger">$ {{ service_fee_total|floatformat:2|intcomma }}</span></td>
            </tr>
            {% if not service_fee_total %}
            <tr>
              <td colspan="2" class="text-muted" style="font-size:0.9rem;">
                Service fee data may be unavailable from Upwork for older transactions.
              </td>
            </tr>
            {% endif %}
            {% if membership_total_display %}
            <tr>
              <td class="w-50">Membership</td>
              <td>: <span class="text-danger">$ {{ membership_total_display|floatformat:2|intcomma }}</span></td>
            </tr>
            {% endif %}
            {% if connect_total_display %}
            <tr>
              <td class="w-50">Connects</td>
              <td>: <span class="text-danger">$ {{ connect_total_display|floatformat:2|intcomma }}</span></td>
            </tr>
            {% endif %}
            <tr>
              <td class="w-50">Charity <abbr title="2.5% from your total earning">(2.5%)</abbr></td>
              <td>: <span class="text-danger">$ {{ graph.charity|floatformat:2|intcomma }}</span></td>
            </tr>
          </table>
        </p>
      </div>
    </div>

    <div id="earning_graph" class="highcharts-graph mb-3"></div>

    {% if not graph.month %}
    <div class="card mt-4">
      <div class="card-body">
        <h3 class="mb-3">Total Earning per Client {{ graph.year }}</h3>
        <div id="client_pie_yearly" style="width:100%; height:420px;"></div>
      </div>
    </div>
    {% endif %}

    {% if graph.month %}
    <div class="card mt-4">
      <div class="card-body">
        <h3 class="mb-3">Total Earning per Client {{ graph.month }} {{ graph.year }}</h3>
        <div id="client_pie" style="width:100%; height:420px;"></div>
      </div>
    </div>
    {% endif %}

    {% if graph.detail_earning and graph.month %}
    <div class="row mt-5">
      <div class="col-lg-12">
        <h3>Earning Detail (Weekly)</h3>
        <div class="table-responsive w-100">
        <table class="table table-hover table-striped table-condensed w-100 earning-detail-weekly">
          <thead>
            <tr>
              <th class="col-num">#</th>
              <th class="text-center col-week">Week</th>
              <th class="text-center col-date">Date</th>
              <th class="col-client">Client</th>
              <th class="col-description">Description</th>
              <th class="text-right col-amount">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for detail in graph.detail_earning %}
            <tr>
              <td class="col-num">{{ forloop.counter }}</td>
              <td class="text-center col-week">{{ detail.week }}</td>
              <td class="text-center col-date">{{ detail.display_date|default:detail.date }}</td>
              <td>{{ detail.client_name }}</td>
              <td>{{ detail.description }}</td>
              <td class="text-right col-amount">$ {{ detail.amount|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% if service_fee_rows %}
    <div class="card mt-4 w-100">
      <div class="card-body w-100">
        <h3>Service Fee</h3>
        <div class="table-responsive w-100">
          <table class="table table-hover table-striped table-condensed w-100">
            <thead>
              <tr>
                <th>#</th>
                <th class="col-date">Date</th>
                <th>Description</th>
                <th class="amount col-amount">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for fee in service_fee_rows %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ fee.display_date|default:fee.date }}</td>
                <td>{{ fee.description }}</td>
                <td class="col-amount">$ {{ fee.amount|floatformat:2|intcomma }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="bg-success">
                <td></td>
                <td>Total</td>
                <td></td>
                <td class="col-amount">$ {{ service_fee_total|floatformat:2|intcomma }}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    {% endif %}

    {% if show_membership_connects %}
    <div class="card mt-4 w-100">
      <div class="card-body w-100">
        <h3>Miscellaneous</h3>
        <div class="table-responsive w-100">
          <table class="table table-hover table-striped table-condensed w-100">
            <thead>
              <tr>
                <th>#</th>
                <th class="col-date">Date</th>
                <th>Type</th>
                <th>Description</th>
                <th class="amount col-amount">Amount</th>
              </tr>
            </thead>
            <tbody>
              {% for row in membership_connect_rows %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ row.display_date }}</td>
                <td>{{ row.type }}</td>
                <td>{{ row.description }}</td>
                <td class="col-amount">$ {{ row.amount|floatformat:2|intcomma }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="bg-success">
                <td></td>
                <td>Total</td>
                <td></td>
                <td></td>
                <td class="col-amount">$ {{ misc_total_display|floatformat:2|intcomma }}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  {% endif %}

{% endblock %}

{% block js_extra %}
<script>
  (function () {
    var baseUrl = "{% url 'total_earning_graph' %}";
    try {
      window.history.replaceState({}, document.title, baseUrl);
    } catch (e) {}
  })();
</script>
<script>
  $(function() {
    $('#year-picker').datetimepicker({
      viewMode: 'years',
      format: 'YYYY',
      ignoreReadonly: true,
    });
    $('#year-picker').on('change.datetimepicker', function () {
      $('#year-form').submit();
    });
  });
</script>

{% autoescape off %}
<script>
  $(function () {
    Highcharts.setOptions({ lang: { thousandsSep: ',' } });

    Highcharts.chart('earning_graph', {
      chart: { type: 'column' },
      title: { text: '{{ page_title }}' },
      subtitle: { text: '{{ graph.title }}' },
      xAxis: { categories: {{ graph.x_axis }} },
      yAxis: { title: { text: 'Dollar ($)' } },
      tooltip: {
        formatter: function() {
          return {{ graph.tooltip }}
        }
      },
      plotOptions: {
        column: {
          stacking: 'normal',
          dataLabels: {
            enabled: true,
            inside: false,
            verticalAlign: 'top',
            y: -20,
            crop: false,
            overflow: 'allow',
            formatter: function () {
              if (!this.y) return '';
              return Highcharts.numberFormat(this.y, 0);
            },
            style: {
              fontWeight: 'bold',
              color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
          }
        },
        series: {
          cursor: 'pointer',
          point: {
            events: {
              click: function () {
                if (this.options.month) {
                  var check_conf = confirm("You are request to check detail month earning.");
                  if (check_conf) {
                    $('input[name=month]').val(this.options.month);
                    $('#year-form').submit();
                  }
                }
              }
            }
          }
        }
      },
      series: [{
        name: 'Earning',
        data: {{ graph.report }},
        color: '#2f7eda',
      }],
      exporting: { enabled: false }
    });
  });
</script>
{% endautoescape %}

{% autoescape off %}
{% if graph.month %}
<script>
$(function () {
  try {
    var pieData = {{ client_pie_data|default:"[]"|safe }};
    pieData = (pieData || []).map(function (p) {
      return { name: p.name, y: Number(p.y) || 0 };
    }).filter(function (p) { return p.y > 0; });

    if (!pieData.length) {
      document.getElementById('client_pie').innerHTML =
        '<div class="text-muted">No client data</div>';
      return;
    }

    var totalUSD = pieData.reduce(function (s, p) { return s + p.y; }, 0);

    Highcharts.chart('client_pie', {
      chart: { type: 'pie' },
      title: { text: null },
      subtitle: {
        text: 'Total: <b>$' + Highcharts.numberFormat(totalUSD, 2) + '</b>',
        align: 'center',
        verticalAlign: 'middle',
        y: 10,
        useHTML: true
      },
      tooltip: {
        useHTML: true,
        formatter: function () {
          return (
            '<b>' + this.point.name + '</b><br/>' +
            '$' + Highcharts.numberFormat(this.point.y, 2) + ' (' +
            Highcharts.numberFormat(this.percentage, 1) + '%)'
          );
        }
      },
      plotOptions: {
        pie: {
          startAngle: -140,
          endAngle: 220,
          innerSize: '55%',
          size: '85%',
          dataLabels: {
            enabled: true,
            distance: 20,
            format: '<b>{point.name}</b><br/>${point.y:,.2f} ({point.percentage:.1f}%)'
          }
        }
      },
      series: [{ name: 'Earning', data: pieData }],
      exporting: { enabled: false }
    });
  } catch (e) {}
});
</script>
{% endif %}
{% endautoescape %}

{% autoescape off %}
{% if not graph.month %}
<script>
$(function () {
  try {
    var pieData = {{ client_pie_data|default:"[]"|safe }};
    pieData = (pieData || []).map(function (p) {
      return { name: p.name, y: Number(p.y) || 0 };
    }).filter(function (p) { return p.y > 0; });

    if (!pieData.length) {
      document.getElementById('client_pie_yearly').innerHTML =
        '<div class="text-muted">No client data</div>';
      return;
    }

    var totalUSD = pieData.reduce(function (s, p) { return s + p.y; }, 0);

    Highcharts.chart('client_pie_yearly', {
      chart: { type: 'pie' },
      title: { text: null },
      subtitle: {
        text: 'Total: <b>$' + Highcharts.numberFormat(totalUSD, 2) + '</b>',
        align: 'center',
        verticalAlign: 'middle',
        y: 10,
        useHTML: true
      },
      tooltip: {
        useHTML: true,
        formatter: function () {
          return (
            '<b>' + this.point.name + '</b><br/>' +
            '$' + Highcharts.numberFormat(this.point.y, 2) + ' (' +
            Highcharts.numberFormat(this.percentage, 1) + '%)'
          );
        }
      },
      plotOptions: {
        pie: {
          startAngle: -140,
          endAngle: 220,
          innerSize: '55%',
          size: '85%',
          dataLabels: {
            enabled: true,
            distance: 20,
            format: '<b>{point.name}</b><br/>${point.y:,.2f} ({point.percentage:.1f}%)'
          }
        }
      },
      series: [{ name: 'Earning', data: pieData }],
      exporting: { enabled: false }
    });
  } catch (e) {}
});
</script>
{% endif %}
{% endautoescape %}

{% endblock %}
