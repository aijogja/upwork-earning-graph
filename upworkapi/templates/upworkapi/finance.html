{% extends "base.html" %}

{% load humanize %}

{% block description %}Input the year, and shown the earning data that presented in graph.{% endblock %}

{% block body %}

<style>
  #earning_graph{
    width: 100%;
    height: 420px;
  }
</style>

<div class="row">
  <div class="col-lg-12">

    <div class="row align-items-center mb-3">
      <div class="col-lg-12">
        <h3 class="mb-0">Earning {{ graph.month }} {{ graph.year }}</h3>
      </div>
    </div>

    <form class="form-inline mb-3 d-flex align-items-center" id="year-form" method="post">
      {% csrf_token %}

      <div class="input-group mr-2" id="year-picker" data-target-input="nearest" style="max-width:240px;">
        <input type="text"
              class="form-control datetimepicker-input"
              data-target="#year-picker"
              readonly
              name="year"
              value="{{ graph.year }}" />
        <div class="input-group-append" data-target="#year-picker" data-toggle="datetimepicker">
          <div class="input-group-text"><i class="fa fa-calendar"></i></div>
        </div>
      </div>

      {% if graph.month %}
      <div class="ml-auto">
        <a href="{% url 'earning_graph' %}?year={{ graph.year }}" class="btn btn-primary">
          ‚Üê Back
        </a>
      </div>
      {% endif %}

      <input type="hidden" name="month" value="">
    </form>

    <div class="row">
      <div class="col-lg-6">
        <p class="lead mb-3">
          <table>
            <tr>
              <td class="w-50">Total Earning</td>
              <td>: <span class="text-success">$ {{ graph.total_earning|intcomma }}</span></td>
            </tr>
            <tr>
              <td class="w-50">Charity <abbr title="2.5% from your total earning">(2.5%)</abbr></td>
              <td>: <span class="text-danger">$ {{ graph.charity|intcomma }}</span></td>
            </tr>
          </table>
        </p>
      </div>
    </div>

    <div id="earning_graph" class="highcharts-graph mb-3"></div>

    {% if graph.month %}
    <div class="card mt-4">
      <div class="card-body">
        <h3 class="mb-3">Earning per Client</h3>
        <div id="client_pie" style="width:100%; height:420px;"></div>
      </div>
    </div>
    {% endif %}

    {% if graph.detail_earning %}
    <div class="row mt-5">
      <div class="col-lg-12">
        <h3>Earning Detail</h3>
        <table class="table table-hover table-striped table-condensed">
          <thead>
            <tr>
              <th>#</th>
              <th class="text-center">Date</th>
              <th>Description</th>
              <th class="amount">Amount</th>
            </tr>
          </thead>
          <tbody>
            {% for detail in graph.detail_earning %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td class="text-center">{{ detail.date }}</td>
              <td>{{ detail.description }}</td>
              <td>$ {{ detail.amount|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="bg-success">
              <td></td>
              <td class="text-center">Total</td>
              <td></td>
              <td>$ {{ graph.total_earning|intcomma }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    {% endif %}

  </div>
</div>


{% endblock %}

{% block js_extra %}
<script>
  $(function() {
    $('#year-picker').datetimepicker({
      viewMode: 'years',
      format: 'YYYY',
      ignoreReadonly: true,
    });
    $('#year-picker').on('change.datetimepicker', function () {
      $('#year-form').submit();
    });
  });
</script>

{% autoescape off %}
<script>
  $(function () {
    Highcharts.setOptions({ lang: { thousandsSep: ',' } });

    var chart = Highcharts.chart('earning_graph', {
      chart: { type: 'column' },
      title: { text: '{{ page_title }}' },
      subtitle: { text: '{{ graph.title }}' },
      xAxis: { categories: {{ graph.x_axis }} },
      yAxis: {
        title: { text: 'Dollar ($)' }
      },
      tooltip: {
        formatter: function () { return {{ graph.tooltip }}; }
      },
      plotOptions: {
        series: {
          cursor: 'pointer',
          point: {
            events: {
              click: function() {
                if (this.options.month) {
                  var ok = confirm("You are request to check detail month earning.");
                  if (ok) {
                    $('input[name=month]').val(this.options.month);
                    $('#year-form').submit();
                  }
                }
              }
            }
          }
        }
      },
      series: [{
        name: 'Earning',
        data: {{ graph.report }},
        color: '#2f7eda'
      }],
      exporting: { enabled: false }
    });

    setTimeout(function () { if (chart) chart.reflow(); }, 100);
  });
</script>
{% endautoescape %}

{% if graph.month %}
<script>
  $(function () {
    try {
      var pieData = {{ client_pie_data|default:"[]"|safe }};

      pieData = (pieData || []).map(function (p) {
        return { name: p.name, y: Number(String(p.y).replace(/[$,]/g, '')) || 0 };
      }).filter(function (p) { return p.y > 0; });

      if (!pieData.length) {
        document.getElementById('client_pie').innerHTML =
          '<div class="text-muted">No client data</div>';
        return;
      }

      var totalUSD = pieData.reduce(function (s, p) { return s + p.y; }, 0);

      Highcharts.chart('client_pie', {
        chart: { type: 'pie' },
        title: { text: null },
        subtitle: {
          text: 'Total: <b>$' + Highcharts.numberFormat(totalUSD, 2) + '</b>',
          align: 'center',
          verticalAlign: 'middle',
          y: 10,
          useHTML: true
        },
        tooltip: { enabled: false },
        plotOptions: {
          pie: {
            innerSize: '55%',
            dataLabels: {
              enabled: true,
              useHTML: true,
              formatter: function () {
                return (
                  '<b>' + this.point.name + '</b><br/>' +
                  '$' + Highcharts.numberFormat(this.point.y, 2) +
                  ' <span style="color:#666">(' +
                  Highcharts.numberFormat(this.percentage, 1) +
                  '%)</span>'
                );
              }
            }
          }
        },
        series: [{ name: 'Earning', data: pieData }],
        exporting: { enabled: false }
      });
    } catch (e) {
      console.error(e);
      document.getElementById('client_pie').innerHTML =
        '<div class="text-danger">Pie chart error (check console)</div>';
    }
  });
</script>
{% endif %}

{% endblock js_extra %}