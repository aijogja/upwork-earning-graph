{% extends "base.html" %}

{% load humanize %}

{% block body %}

<style>
  #earning_graph{
    width: 100%;
    height: 420px;
  }
  #client_pie, #client_pie_yearly{
  width: 100%;
  min-height: 520px;
  }
  .col-date{
    width: 140px;
    white-space: nowrap;
  }
  @media (max-width: 576px){
    #client_pie, #client_pie_yearly{
      min-height: 420px;
    }
  }
</style>

<div class="row">
  <div class="col-lg-12">

    <div class="row align-items-center mb-3">
      <div class="col-lg-12">
        <h3 class="mb-0">Earning {{ graph.month }} {{ graph.year }}</h3>
      </div>
    </div>

    <form class="form-inline mb-3 d-flex align-items-center"
      id="year-form"
      method="get"
      action="{% url 'fixed_price_graph' %}">

      <div class="input-group mr-2" id="year-picker" data-target-input="nearest" style="max-width:240px;">
        <input type="text"
              class="form-control datetimepicker-input"
              data-target="#year-picker"
              readonly
              name="year"
              value="{{ graph.year }}" />
        <div class="input-group-append" data-target="#year-picker" data-toggle="datetimepicker">
          <div class="input-group-text"><i class="fa fa-calendar"></i></div>
        </div>
      </div>

      <div class="ml-auto">
        <a href="{% url 'fixed_price_graph' %}?year={{ graph.year }}" class="btn btn-primary">
          ← Back
        </a>
      </div>

      <input type="hidden" name="month" value="">
    </form>

    <div class="row">
      <div class="col-lg-6">
        <p class="lead mb-3">
          <table>
            <tr>
              <td class="w-50">Total Earning</td>
              <td>: <span class="text-success">$ {{ graph.total_earning|intcomma }}</span></td>
            </tr>
            <tr>
              <td class="w-50">Service Fee</td>
              <td>: <span class="text-danger">$ {{ service_fee_total|floatformat:2|intcomma }}</span></td>
            </tr>
            <tr>
              <td class="w-50">Charity <abbr title="2.5% from your total earning">(2.5%)</abbr></td>
              <td>: <span class="text-danger">$ {{ graph.charity|intcomma }}</span></td>
            </tr>
          </table>
        </p>
      </div>
    </div>

    <div id="earning_graph" class="highcharts-graph mb-3"></div>

    <div class="card mt-4">
      <div class="card-body">
        <h3 class="mb-3">Earning per Client {{ graph.month }} {{ graph.year }}</h3>
        <div id="client_pie" style="width:100%; height:420px;"></div>
      </div>
    </div>

    {% if graph.detail_earning and graph.month %}
    <div class="row mt-5">
      <div class="col-lg-12">
        <h3>Earning Detail</h3>
        <div class="table-responsive w-100">
        <table class="table table-hover table-striped table-condensed w-100">
          <thead>
            <tr>
              <th>#</th>
              <th class="text-center col-date">Date</th>
              <th>Client</th>
              <th>Description</th>
              <th class="amount">Amount</th>
            </tr>
          </thead>
          <tbody>
              {% for detail in graph.detail_earning %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td class="text-center col-date">{{ detail.display_date|default:detail.date }}</td>
              <td>{{ detail.client }}</td>
              <td>{{ detail.description }}</td>
              <td>$ {{ detail.amount|floatformat:2|intcomma }}</td>
            </tr>
            {% endfor %}
          </tbody>
          <tfoot>
            <tr class="bg-success">
              <td></td>
              <td class="text-center">Total</td>
              <td></td>
              <td></td>
              <td>$ {{ graph.total_earning|intcomma }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    </div>
    {% if service_fee_rows %}
    <div class="row mt-4">
      <div class="col-lg-12">
        <h3>Service Fee</h3>
        <div class="table-responsive w-100">
          <table class="table table-hover table-striped table-condensed w-100">
            <thead>
            <tr>
              <th>#</th>
              <th class="text-center col-date">Date</th>
              <th>Description</th>
              <th class="amount">Amount</th>
            </tr>
            </thead>
            <tbody>
              {% for fee in service_fee_rows %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td class="text-center col-date">{{ fee.display_date|default:fee.date|default:fee.occurred_at }}</td>
                <td>{{ fee.description_ui|default:fee.description }}</td>
                <td>$ {{ fee.amount|floatformat:2|intcomma }}</td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr class="bg-success">
                <td></td>
                <td class="text-center">Total</td>
                <td></td>
                <td>$ {{ service_fee_total|floatformat:2|intcomma }}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
  {% endif %}

{% endblock %}

{% block js_extra %}
<script>
  $(function() {
    $('#year-picker').datetimepicker({
      viewMode: 'years',
      format: 'YYYY',
      ignoreReadonly: true,
    });
    $('#year-picker').on('change.datetimepicker', function () {
      $('#year-form').submit();
    });
  });
</script>

{% autoescape off %}
<script>
  $(function () {
    Highcharts.setOptions({ lang: { thousandsSep: ',' } });

    var earningChart = Highcharts.chart('earning_graph', {
      chart: { type: 'column' },
      title: { text: '{{ page_title }}' },
      subtitle: { text: '{{ graph.title }}' },
      xAxis: { categories: {{ graph.x_axis }} },
      yAxis: { title: { text: 'Dollar ($)' } },

      tooltip: {
        formatter: function() {
          return {{ graph.tooltip }}
        }
      },
      plotOptions: {
        column: {
          stacking: 'normal',
          dataLabels: {
            enabled: true,
            inside: false,
            verticalAlign: 'top',
            y: -20,
            crop: false,
            overflow: 'allow',
            formatter: function () {
              if (!this.y) return '';
              return Highcharts.numberFormat(this.y, 0);
            },
            style: {
            fontWeight: 'bold',
            color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
          }
        },
  series: {
    cursor: 'pointer',
    point: {
      events: {
        click: function () {
          if (this.options.month) {
            var check_conf = confirm("You are request to check detail month earning.");
            if (check_conf) {
              $('input[name=month]').val(this.options.month);
              $('#year-form').submit();
            }
          }
        }
      }
    }
  }
},
      series: [{
        name: 'Earning',
        data: {{ graph.report }},
        color: '#2f7eda',
      }],
      exporting: {
        url: 'http://export.highcharts.com/',
        enabled: false,
      }
  });
  });
</script>
{% endautoescape %}

{% autoescape off %}
<script>
$(function () {
  try {
    var pieData = {{ client_pie_data|default:"[]"|safe }};
    pieData = (pieData || []).map(function (p) {
      return { name: p.name, y: Number(p.y) || 0 };
    }).filter(function (p) { return p.y > 0; });

    if (!pieData.length) {
      document.getElementById('client_pie').innerHTML =
        '<div class="text-muted">No client data</div>';
      return;
    }

      var totalUSD = pieData.reduce(function (s, p) { return s + p.y; }, 0);

    Highcharts.chart('client_pie', {
      chart: { type: 'pie' },
      title: { text: null },
      subtitle: {
        text: 'Total: <b>$' + Highcharts.numberFormat(totalUSD, 2) + '</b>',
        align: 'center',
        verticalAlign: 'middle',
        y: 10,
        useHTML: true
      },

      tooltip: {
        useHTML: true,
        formatter: function () {
          return (
            '<b>' + this.point.name + '</b><br/>' +
            '$' + Highcharts.numberFormat(this.point.y, 2) + ' (' +
            Highcharts.numberFormat(this.percentage, 1) + '%)'
          );
        }
      },

          // Desktop pie chart style monthly

      plotOptions: {
        pie: {
          startAngle: -140,
          endAngle: 220,
          innerSize: '55%',
          size: '85%',
          dataLabels: {
            enabled: true,
            useHTML: false,
            distance: 18,
            crop: false,
            overflow: 'none',
            style: {
              fontSize: '11px',
              textOutline: 'none'
            },
            formatter: function () {
              return (
                '<b>' + this.point.name + '</b><br/>' +
                '$' + Highcharts.numberFormat(this.point.y, 2) +
                ' <span style="color:#666">(' +
                Highcharts.numberFormat(this.percentage, 1) +
                '%)</span>'
              );
            }
          }
        }
      },

      // Mobile pie chart style monthly
      responsive: {
        rules: [{
          condition: { maxWidth: 576 },
          chartOptions: {
            chart: { height: 420, spacingLeft: 40, spacingRight: 40 },
            plotOptions: {
              pie: {
                startAngle: -140,
                endAngle: 220,
                size: '85%',
                dataLabels: {
                  enabled: true,
                  distance: 12,
                  useHTML: false,
                  style: { fontSize: '10px', textOverflow: 'none', lineHeight: '12px' },
                  formatter: function () {
                    var name = (this.point.name || '').trim();
                    if (name.length > 25) name = name.slice(0, 25) + '…';
                    var pct = Highcharts.numberFormat(this.percentage, 1) + '%';
                    return '<b>' + name + '</b><br/>' + pct;
                  }
                }
              }
            }
          }
        }]
      },


      series: [{
        name: 'Earning',
        data: pieData
      }],

      exporting: { enabled: false }
    });

    setTimeout(function () { monthlyPie.reflow(); }, 0);
    window.addEventListener('resize', function () { monthlyPie.reflow(); });
    window.addEventListener('orientationchange', function () { monthlyPie.reflow(); });

  } catch (e) {
    console.error(e);
    document.getElementById('client_pie').innerHTML =
      '<div class="text-danger">Pie chart error</div>';
  }
});
</script>
{% endautoescape %}

{% endblock js_extra %}
