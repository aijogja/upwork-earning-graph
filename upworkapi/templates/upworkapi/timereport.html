{% extends "base.html" %}

{% load humanize %}

{% block description %}Input the year, and shown the timereport data that presented in graph.{% endblock %}

{% block body %}
<style>
  #timereport_client_pie{
    width: 100%;
    min-height: 520px;
  }
  @media (max-width: 576px){
    #timereport_client_pie{
      min-height: 420px;
    }
  }
</style>
<div class="row">
  <div class="col-lg-12">
    <h3>Time Report {{ graph.year }}</h3>
    <form class="form-inline" id="year-form" method="post">
      {% csrf_token %}
      <div class="input-group date mr-sm-1 pl-0 mb-2 col-lg-3" id="year-picker" data-target-input="nearest">
        <input type="text" class="form-control datetimepicker-input" data-target="#year-picker" readonly name="year" value="{{ graph.year }}" />
        <div class="input-group-append" data-target="#year-picker" data-toggle="datetimepicker">
          <div class="input-group-text"><i class="fa fa-calendar"></i></div>
        </div>
      </div>
      <input type="hidden" name="month" value="">
    </form>
      <div class="row">
        <div class="col-lg-6">
          <p class="lead">
            <table>
              <tr>
                <td class="w-50">Total Hour (per year)</td>
                <td>: <span class="text-success">{{ graph.total_hours|intcomma }} hours</span></td>
              </tr>
              <tr>
                <td class="w-50">Average (per week)</td>
                <td>: <span class="text-{{ graph.work_status }}">{{ graph.avg_week }} hours</span></td>
              </tr>
            </table>
          </p>
        </div>
      </div>

      <div id="timereport_graph" class="highcharts-graph"></div>
      <div class="card mt-4">
        <div class="card-body">
          <h3 class="mb-3">Time Report per Client</h3>
          <div id="timereport_client_pie" style="width:100%; height:420px;"></div>
        </div>
      </div>
  </div>
</div>
{% endblock %} 

{% block js_extra %}
<script>
  $(function() { 
    // Datepicker year select
    $('#year-picker').datetimepicker({
      viewMode: 'years',
      format: 'YYYY',
      ignoreReadonly: true,
    });
    $('#year-picker').on('change.datetimepicker', function (e) {
      $('#year-form').submit()
    })
  });
</script>

{% autoescape off %}
<script>
  function formating_time(total_time){
    hours = parseInt(total_time)
    minutes = parseInt(((total_time*60)%60).toFixed(2))
    if(minutes == 0){
      result = hours + ':00'
    }else{
      result = hours + ':' + minutes
    }
    return result
  }

  $(function () { 
    $('#timereport_graph').highcharts({
      chart: {
        type: 'column'
      },
      title: {
        text: '{{ page_title }}'
      },
      subtitle: {
        text : '{{ graph.title }}'
      },
      xAxis: {
        title: {
          text: 'Weeks'
        },
        categories: {{ graph.x_axis }}
      },
      yAxis: {
        title: {
          text: 'Hours'
        },
        stackLabels: {
          enabled: true,
          style: {
            fontWeight: 'bold',
            color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
          }
        }
      },
      legend: {
        align: 'right',
        x: -70,
        verticalAlign: 'top',
        y: 20,
        floating: true,
        backgroundColor: (Highcharts.theme && Highcharts.theme.legendBackgroundColorSolid) || 'white',
        borderColor: '#CCC',
        borderWidth: 1,
        shadow: false
      },
      tooltip: {
        formatter: function() {
          return {{ graph.tooltip }}
        }
      },
      series: [{
        name: 'Time Report',
        data: {{ graph.report }},
        color: '#2f7eda',
      }],
      exporting: {
        url: 'http://export.highcharts.com/',
        enabled: false
        
      }
    });
  });
</script>
{% endautoescape %}

{% autoescape off %}
<script>
  $(function () {
    try {
      var pieData = {{ graph.client_pie_data|default:"[]"|safe }};
      pieData = (pieData || []).map(function (p) {
        return { name: p.name, y: Number(p.y) || 0 };
      }).filter(function (p) { return p.y > 0; });

      if (!pieData.length) {
        document.getElementById('timereport_client_pie').innerHTML =
          '<div class="text-muted">No client data</div>';
        return;
      }

      var totalHours = pieData.reduce(function (s, p) { return s + p.y; }, 0);

      var timeReportPie = Highcharts.chart('timereport_client_pie', {
        chart: { type: 'pie' },
        title: { text: null },
        subtitle: {
          text: 'Total: <b>' + Highcharts.numberFormat(totalHours, 1) + ' hrs</b>',
          align: 'center',
          verticalAlign: 'middle',
          y: 10,
          useHTML: true
        },
        tooltip: {
          useHTML: true,
          formatter: function () {
            return (
              '<b>' + this.point.name + '</b><br/>' +
              Highcharts.numberFormat(this.point.y, 1) + ' hrs (' +
              Highcharts.numberFormat(this.percentage, 1) + '%)'
            );
          }
        },
        plotOptions: {
          pie: {
            startAngle: -150,
            endAngle: 210,
            innerSize: '55%',
            size: '85%',
            dataLabels: {
              enabled: true,
              distance: 18,
              formatter: function () {
                return (
                  '<b>' + this.point.name + '</b><br/>' +
                  Highcharts.numberFormat(this.point.y, 1) + ' hrs (' +
                  Highcharts.numberFormat(this.percentage, 1) + '%)'
                );
              }
            }
          }
        },
        responsive: {
          rules: [{
            condition: { maxWidth: 576 },
            chartOptions: {
              chart: { height: 420, spacingLeft: 60, spacingRight: 60 },
              plotOptions: {
                pie: {
                  size: '86%',
                  dataLabels: {
                    enabled: true,
                    distance: 12,
                    crop: false,
                    overflow: 'none',
                    style: { fontSize: '8px', lineHeight: '12px', textOverflow: 'none' },
                    formatter: function () {
                      var name = (this.point.name || '').trim();
                      name = name.replace(/\s+/g, '\u00A0');
                      var pct = Highcharts.numberFormat(this.percentage, 1) + '%';
                      if (name.length > 20) {
                        name = name.slice(0, 20) + 'â€¦';
                        return '<b>' + name + '</b><br/>' + pct;
                      }
                      return '<b>' + name + '</b> ' + pct;
                    }
                  }
                }
              }
            }
          }]
        },
        series: [{ name: 'Hours', data: pieData }],
        exporting: { enabled: false }
      });
      setTimeout(function () { timeReportPie.reflow(); }, 0);
      window.addEventListener('resize', function () { timeReportPie.reflow(); });
      window.addEventListener('orientationchange', function () { timeReportPie.reflow(); });
    } catch (e) {}
  });
</script>
{% endautoescape %}
{% endblock js_extra %}