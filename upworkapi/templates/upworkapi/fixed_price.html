{% extends "base.html" %}
{% load humanize %}

{% block body %}

<style>
  #earning_graph{
    width: 100%;
    height: 420px;
  }
  #client_pie_yearly{
    width: 100%;
    min-height: 520px;
  }
  .col-date{
    width: 140px;
    white-space: nowrap;
  }
  .col-amount{
    width: 120px;
    white-space: nowrap;
    text-align: right;
  }
  .amount{
    text-align: right;
  }
  .fixed-details-table{
    width: 100%;
    table-layout: fixed;
  }
  .fixed-details-table .col-client{
    width: 180px;
  }
  .fixed-details-table .col-desc{
    width: auto;
  }
  @media (max-width: 576px){
    #client_pie_yearly{
      min-height: 420px;
    }
  }
</style>

<div class="row">
  <div class="col-lg-12">

    <div class="row align-items-center mb-3">
      <div class="col-lg-12 d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Fixed Price & Bonus {{ year }}</h3>
      </div>
    </div>

    <form class="form-inline mb-3 d-flex align-items-center"
      id="year-form"
      method="get"
      action="{% url 'fixed_price_graph' %}">
      <div class="input-group mr-2" id="year-picker" data-target-input="nearest" style="max-width:240px;">
        <input type="text"
              class="form-control datetimepicker-input"
              data-target="#year-picker"
              readonly
              name="year"
              value="{{ year }}" />
        <div class="input-group-append" data-target="#year-picker" data-toggle="datetimepicker">
          <div class="input-group-text"><i class="fa fa-calendar"></i></div>
        </div>
      </div>
    </form>

    <div class="row">
      <div class="col-lg-6">
        <p class="lead mb-3">
          <table>
            <tr>
              <td class="w-50">Total Earning</td>
              <td>: <span class="text-success">$ {{ total|floatformat:2|intcomma }}</span></td>
            </tr>
            <tr>
              <td class="w-50">Service Fee</td>
              <td>: <span class="text-danger">$ {{ service_fee_total|floatformat:2|intcomma }}</span></td>
            </tr>
            <tr>
              <td class="w-50">Charity <abbr title="2.5% from your total earning">(2.5%)</abbr></td>
              <td>: <span class="text-danger">$ {{ charity|floatformat:2|intcomma }}</span></td>
            </tr>
          </table>
        </p>
      </div>
    </div>

    {% if debug_info %}
    <div class="alert alert-warning">
      <div><b>Debug Info</b></div>
      <div><b>References:</b> {{ debug_info.references }}</div>
      <div><b>Params:</b> {{ debug_info.params_tried }}</div>
      <div><b>Endpoint:</b> {{ debug_info.endpoint }}</div>
      <div><b>ACE IDs:</b> {{ debug_info.ace_ids }}</div>
      <div><b>GraphQL attempts:</b> {{ debug_info.graphql_attempts }}</div>
      <div><b>Payload keys:</b> {{ debug_info.payload_top_keys }}</div>
      {% if debug_info.payload_message %}
      <div><b>Payload message:</b> {{ debug_info.payload_message }}</div>
      {% endif %}
      {% if debug_info.payload_error %}
      <div><b>Payload error:</b> {{ debug_info.payload_error }}</div>
      {% endif %}
      <div><b>Row count:</b> {{ debug_info.row_count }}</div>
      <div><b>Sample keys:</b> {{ debug_info.sample_keys }}</div>
      <div><b>Sample row:</b> {{ debug_info.sample_row }}</div>
      {% if debug_info.error %}
      <div><b>Error:</b> {{ debug_info.error }}</div>
      {% endif %}
    </div>
    {% endif %}

    <div id="earning_graph" class="highcharts-graph mb-3"></div>

    <div class="card mt-4">
      <div class="card-body">
        <h3 class="mb-3">Earning per Client {{ year }}</h3>
        <div id="client_pie_yearly" style="width:100%; height:420px;"></div>
      </div>
    </div>

    {% if show_detail_table and rows|length <= 20 %}
      <div class="row mt-5">
        <div class="col-lg-12">
          <h3>Earning Details</h3>
          <div class="table-responsive w-100">
            <table class="table table-hover table-striped table-condensed w-100 fixed-details-table">
              <thead>
                <tr>
                  <th class="col-date">Date</th>
                  <th class="col-client">Client</th>
                  <th class="col-desc">Description</th>
                  <th class="text-right col-amount">Amount</th>
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                <tr>
                  <td class="col-date">{{ r.display_date|default:r.date }}</td>
                  <td>{{ r.client }}</td>
                  <td style="white-space: normal;">{{ r.description }}</td>
                  <td class="text-right col-amount">$ {{ r.amount|floatformat:2|intcomma }}</td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted">No data</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block js_extra %}
<script>
  $(function() {
    $('#year-picker').datetimepicker({
      viewMode: 'years',
      format: 'YYYY',
      ignoreReadonly: true,
    });
    $('#year-picker').on('change.datetimepicker', function () {
      $('#year-form').submit();
    });
  });
</script>
{% autoescape off %}
<script>
  $(function () {
    Highcharts.setOptions({ lang: { thousandsSep: ',' } });

    Highcharts.chart('earning_graph', {
      chart: { type: 'column' },
      title: { text: 'Fixed/Bonus Graph' },
      subtitle: { text: 'Year : {{ year }} ($ {{ total|floatformat:2 }})' },
      xAxis: { categories: {{ x_axis|safe }} },
      yAxis: { title: { text: 'Dollar ($)' } },
      tooltip: {
        formatter: function () {
          return '<b>' + this.x + '</b><br/>$ ' + Highcharts.numberFormat(this.y, 2);
        }
      },
      plotOptions: {
        column: {
          dataLabels: {
            enabled: true,
            inside: false,
            verticalAlign: 'top',
            y: -20,
            crop: false,
            overflow: 'allow',
            formatter: function () {
              if (!this.y) return '';
              return Highcharts.numberFormat(this.y, 0);
            },
            style: {
              fontWeight: 'bold',
              color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray'
            }
          }
        },
        series: {
          cursor: 'pointer',
          point: {
            events: {
              click: function () {
                if (this.options.month) {
                  var baseUrl = '{% url "fixed_price_graph" %}';
                  baseUrl = baseUrl.replace(/\/$/, '');
                  window.location.href = baseUrl + '/' + {{ year }} + '/' + this.options.month;
                }
              }
            }
          }
        }
      },
      series: [{
        name: 'Earning',
        data: {{ report|safe }},
        color: '#2f7eda'
      }],
      exporting: { enabled: false }
    });
  });
</script>
{% endautoescape %}

{% autoescape off %}
<script>
  $(function () {
    try {
      var pieData = {{ client_pie_data|default:"[]"|safe }};
      pieData = (pieData || []).map(function (p) {
        return { name: p.name, y: Number(p.y) || 0 };
      }).filter(function (p) { return p.y > 0; });

      if (!pieData.length) {
        document.getElementById('client_pie_yearly').innerHTML =
          '<div class="text-muted">No client data</div>';
        return;
      }

      var totalUSD = pieData.reduce(function (s, p) { return s + p.y; }, 0);

      Highcharts.chart('client_pie_yearly', {
        chart: { type: 'pie' },
        title: { text: null },
        subtitle: {
          text: 'Total: <b>$' + Highcharts.numberFormat(totalUSD, 2) + '</b>',
          align: 'center',
          verticalAlign: 'middle',
          y: 10,
          useHTML: true
        },
      tooltip: {
        useHTML: true,
        formatter: function () {
          return (
            '<b>' + this.point.name + '</b><br/>' +
            '$' + Highcharts.numberFormat(this.point.y, 2) + ' (' +
            Highcharts.numberFormat(this.percentage, 1) + '%)'
          );
        }
      },
        plotOptions: {
          pie: {
            startAngle: -140,
            endAngle: 220,
            innerSize: '55%',
            size: '85%',
            dataLabels: {
              enabled: true,
              distance: 20,
              format: '<b>{point.name}</b><br/>${point.y:,.2f} ({point.percentage:.1f}%)'
            }
          }
        },
        series: [{ name: 'Earning', data: pieData }],
        exporting: { enabled: false }
      });
    } catch (e) {}
  });
</script>
{% endautoescape %}
{% endblock js_extra %}
